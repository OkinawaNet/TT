## Домашнее задание 4

### 1. ADR-001

| **Title**       | [ADR-001] Переход формальной асинхронной event-driven на синхронную для доставки рейтинга                                                                                                                                                                                                 |
|-----------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Status**      | Accepted (2025-07-11)  |
| **Context**     | [Problem-030] Логика начисления бонусов некорректна из-за ошибки с рейтингом задания. Проблема возникла из-за eventual consistency. Для решения проблемы нужно добиться strong consistency.                                                                          |
| **Decision**    |  Переход формальной асинхронной event-driven на синхронную коммуникацию. (async TaskRating -> polling HTTP-вызов )                                                                 |
| **Consequences**| **Положительные:**<br>- Обеспечение strong consistency<br>**Отрицательные:**<br>-каплинг<br>|
| **Alternatives**| • Альтернатива: Использовать события И для начисления бонусов И для отправки рейтинга, выстроить последовательность по условиям в DLQ. повысит консистентность<br> Не выбрано, потому-что это всё равно не strong consistency. Логика тоже неочевидная и риск получить очень сильное расхождение будет всегда. |


### 2. Проблемы бизнеса

| Название проблемы | Из-за чего проблема появилась | Как проблема решилась |
|-------------------|-------------------------------|-----------------------|
| [Problem-010] Долго определяется правильность выполнения задания от кандидата. Это вызывает задержки, которые раздражают менеджеров и кандидатов в учителя. | Выполняются синхронные запросы в сервис заданий [COMM-20] и в сервис бонусов [COMM-30], [COMM-40], [COMM-50]. | Коммуникации [COMM-30], [COMM-40], [COMM-50] были переведены на асинхронные, избавились от каплинга. |
| [Problem-020] Кандидаты в учителя обходят систему в месте, где простое задание должно усложниться, но этого ещё не произошло. Для этого они собираются в группы, где делятся лёгкими заданиями между собой, и, пока задание обновляется, массово выполняют лёгкие версии. UPDATED: [Problem-020] Главная проблема тут в том, что нужно как можно быстрее менять задание для кандидатов в учителя после того, как менеджер поправит задание. | Синхронный вызов начисления денег менеджеру [COMM-080] тормозит обновление задачи. | [COMM-80] была заменена на асинхронную коммуникацию, что избавило от каплинга. |
| [Problem-030] Логика начисления бонусов некорректна из-за ошибки с рейтингом задания. Во время начисления бонусов при изменении рейтинга происходит задержка, которая не удовлетворяет бизнес-требованиям (нужно моментально). | Eventual consistency для рейтинга. | Переход с формальной асинхронной [COMM-60] event-driven на синхронную коммуникацию (async TaskRating → HTTP-вызов). |
| [Problem-040] Медленно начисляются бонусы менеджерам из-за большого количества кандидатов в учителя. Иногда вся система падает и не восстанавливается. | Много блокирующих синхронных запросов ([COMM-30], [COMM-40], [COMM-50]). | Коммуникации [COMM-30], [COMM-40], [COMM-50] были переведены на асинхронные, избавились от каплинга, что повысило elasticity. |
| [Problem-050] В UI может отобразиться ошибка выполнения запросов после успешного выполнения задания. Разработчики объясняют это поведение вызовом сервиса оплаты и создания заданий. | Наличие синхронных блокирующих коммуникаций [COMM-30], [COMM-40], [COMM-50]. Если они умирают — отображается ошибка. | Коммуникации [COMM-30], [COMM-40], [COMM-50] были переведены на асинхронные, а значит никаких ошибок выполнения запросов (если только брокер не сломается). |
| [Problem-060] Нужно сократить расходы на масштабирование сервиса заданий. Сейчас это дорого. | Входящие синхронные запросы [COMM-30], [COMM-90] усложняют масштабирование. | Асинхронные коммуникации облегчат масштабирование. Сервис сейчас читает и отправляет только события. А значит не будет проблем развернуть ещё один инстанс. Каплинг низкий. |
| [Problem-070] Менеджерам иногда начисляются бонусы дважды. Это связано с тем, что когда кандидаты в учителя отправляют то же самое задание повторно, система зависает [Problem-050]. Разработчики объясняют тем, что управление заданиями падает, а бонусами — нет. Из-за этого бонусы попадают в два одинаковых запроса. | Отсутствие идемпотентности при начислении бонусов. | Идемпотентность обеспечивается использованием ON CONFLICT DO NOTHING при обработке события TaskSolved. |
| [Problem-080] Упавший сервис создания заданий или бонусов выводит из строя всю систему, и кандидаты в учителя не могут выполнять задания. | Много синхронных запросов. Если один сервис падает — ломается вся бизнес-логика. | Event-driven коммуникации позволят сервису работать без проблем в случае отказа других сервисов. |
| [Problem-090] Фичи выходят слишком медленно. Это связано с тем, что для выполнения любой фичи нужно изучить всю систему и проверить, что ничего не упало. Разработчики сами не понимают, как работает система вне отдельного сервиса. | Много каплинга, утечек абстракций. | Event-driven коммуникации избавят от утечек абстракций. Будет достаточно понимания одного сервиса. |
| [Problem-100] Данные теряются в логике выполнения заданий кандидатами в учителя. | Много синхронных запросов. Если один сервис падает — ломается вся бизнес-логика. | Переход на асинхронные события [COMM-30], [COMM-40], [COMM-50] уменьшит риск потери данных. |